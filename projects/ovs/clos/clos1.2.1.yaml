# clos1.2に加えて、br-exにipを付けて疎通取れるようにする
imports:
  - infra/local/remote.yaml
  - infra/ovs/clos/clos1.yaml
  - infra/ovs/clos/clos1.1.yaml

ipam:
  ovsadmin_network1:
    subnet: 10.10.20.0/24
    kind: l3
  vm_network1:
    subnet: 10.100.0.0/24
    kind: l2

template_map:
  hv:
    ovs:
      admin_ips:
        - inet: <%=assign_inet4(ovsadmin_network1)%>
      bridges:
        - name: br-ex
          kind: external-ha
          links:
            - peer: br-int
              flows:
                - kind: ingress
                - kind: egress
        - name: br-int
          kind: internal-vm
    frr:
      route_map:
        VM-v4:
          policy: permit
          order: 5
          version: 4
          prefix_list:
            - seq 5 permit <%=ipam.vm_network1.subnet%> le 32
            - seq 6 permit <%=ipam.ovsadmin_network1.subnet%> le 32
      ipv4_networks:
        - <%=l3admin.ips.0.inet%>
        - <%=ovs.admin_ips.0.inet%>
        - <%=vm_links.0.peer_ips.0.ip%>/32
  vm:
    mtu: 1500
    routes:
      - dst: default
        via: <%=gateway_ip(_links.0.peer_ips.0.network)%>

node_map:
  CL1:
    tests:
      - kind: ping
        targets:
          - name: vm1
            dst: <%=_node_map.vm1._links.0.peer_ips.0.ip%>
          - name: HV1.ovs
            dst: <%=_node_map.HV1.ovs.admin_ips.0.ip%>
  HV1:
    vm_links:
      - peer: vm1
        peer_ips:
          - inet: <%=assign_inet4(vm_network1)%>
    vms:
      - name: vm1
        templates:
          - node
          - vm
