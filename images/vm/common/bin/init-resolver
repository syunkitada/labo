#!/bin/bash -xe

cd $(dirname $0)
source envrc

if [ "$OS_NAME" = "CentOS" ] && [ "$OS_VERSION" = "7" ]; then
    echo "# Generated by init-resolver" > /etc/resolv.conf
    for resolver in "$@"
    do
        echo "nameserver ${resolver}" >> /etc/resolv.conf
    done
    echo "Generated /etc/resolv.conf
------------------------------------"
    cat /etc/resolv.conf
fi

if [ "$OS_NAME" = "Ubuntu" ]; then
    mkdir -p /etc/systemd/resolved.conf.d/

    echo "# Generated by init-resolver" > /etc/systemd/resolved.conf.d/labo.conf
    for resolver in "$@"
    do
        echo "
[Resolve]
DNS=${resolver}
# FallbackDNS=
# Domains=
LLMNR=no
MulticastDNS=no
DNSSEC=no
Cache=yes
DNSStubListener=yes
" >> /etc/systemd/resolved.conf.d/labo.conf
    done

    echo "Generated /etc/systemd/resolved.conf.d/labo.conf"
    systemctl enable systemd-resolved
    systemctl restart systemd-resolved
fi
